<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kecoaxx Devices</title>
<style>
body { font-family:"Roboto", sans-serif; background:#121212; color:#e0e0e0; margin:0; padding:10px; }
h1 { text-align:center; margin:10px 0 18px 0; font-size:1.4rem; color:#fff; }
.table-container { overflow-x:auto; }
table { width:100%; min-width:400px; border-collapse:collapse; background:#1e1e1e; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.6); font-size:0.7rem; }
thead { background:#272727; }
th, td { padding:6px 10px; text-align:left; cursor:default; }
th { color:#90caf9; font-weight:480; border-bottom:1px solid #333; white-space:nowrap; }
tr:nth-child(even) { background:#2a2a2a; }
tr:hover { background:#333; }
td { border-bottom:1px solid #2c2c2c; vertical-align:middle; }
.empty { text-align:center; padding:16px; color:#888; }
.filters { margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; }
th.sortable { cursor:pointer; }
</style>
</head>
<body>

<h1>Kecoaxx Devices</h1>

<div class="filters">
  <input type="text" id="searchName" placeholder="Cari nama..." />
  <select id="timeRange">
    <option value="today">Hari ini</option>
    <option value="all">Semua</option>
  </select>
  <select id="limit">
    <option value="all">Semua</option>
    <option value="10">10</option>
    <option value="20">20</option>
  </select>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Nama</th>
        <th class="sortable">Sent ▲▼</th>
        <th>Device</th>
        <th>Versi bot</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="devices-table">
      <tr><td colspan="5" class="empty">Loading data...</td></tr>
    </tbody>
  </table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWrIDwTn4Byd9gZdYeGtwVUe0q2f2KYT4",
  authDomain: "kecoaxx-db898.firebaseapp.com",
  databaseURL: "https://kecoaxx-db898-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kecoaxx-db898",
  storageBucket: "kecoaxx-db898.firebasestorage.app",
  messagingSenderId: "929070876762",
  appId: "1:929070876762:web:696c8699f91e8022cc7063"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const devicesRef = ref(db, "devices");

const searchName = document.getElementById("searchName");
const timeRange = document.getElementById("timeRange");
const limit = document.getElementById("limit");
const table = document.getElementById("devices-table");

let devicesData = [];
let sortSentAsc = true;

function renderTable() {
  table.innerHTML = "";

  let filtered = devicesData.filter(d => (d.botName||"").toLowerCase().includes(searchName.value.toLowerCase()));
  let lim = limit.value === "all" ? filtered.length : parseInt(limit.value);

  filtered.slice(0, lim).forEach(d => {
    let sent = timeRange.value === "today" ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
    const row = `
      <tr>
        <td>${d.botName||"-"}</td>
        <td>${sent}</td>
        <td>${d.deviceName||d.id}</td>
        <td>${d.appVersion||"-"}</td>
        <td>${d.status||"-"}</td>
      </tr>
    `;
    table.innerHTML += row;
  });

  if(filtered.length === 0) table.innerHTML = `<tr><td colspan="5" class="empty">Tidak ada data</td></tr>`;
}

onValue(devicesRef, snapshot => {
  devicesData = [];
  snapshot.forEach(child => {
    const data = child.val();
    data.id = child.key;
    devicesData.push(data);
  });
  renderTable();
}, err => {
  console.error("❌ Error ambil data:", err);
  table.innerHTML = `<tr><td colspan="5" class="empty">Error ambil data</td></tr>`;
});

// Search / filter / limit
[searchName, timeRange, limit].forEach(el => el.addEventListener("input", renderTable));

// Sort Sent column
document.querySelector("th.sortable").addEventListener("click", () => {
  devicesData.sort((a,b) => {
    const valA = timeRange.value === "today" ? (a.sentToday ?? 0) : (a.totalSent ?? 0);
    const valB = timeRange.value === "today" ? (b.sentToday ?? 0) : (b.totalSent ?? 0);
    return sortSentAsc ? valB - valA : valA - valB; // klik pertama: terbesar dulu
  });
  sortSentAsc = !sortSentAsc;
  renderTable();
});
</script>

</body>
</html>
