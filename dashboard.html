<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kecoaxx Dashboard</title>
<style>
body { font-family:"Roboto", sans-serif; background:#121212; color:#e0e0e0; margin:0; padding:10px; }
h1 { text-align:center; margin:10px 0 18px 0; font-size:1.4rem; color:#fff; }
.table-container { overflow-x:auto; margin-bottom:10px; }
table { width:100%; min-width:350px; border-collapse:collapse; background:#1e1e1e; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.6); font-size:0.7rem; }
thead { background:#272727; }
th, td { padding:6px 10px; text-align:left; cursor:default; }
th { color:#90caf9; font-weight:480; border-bottom:1px solid #333; white-space:nowrap; }
tr:nth-child(even) { background:#2a2a2a; }
tr:hover { background:#333; }
td { border-bottom:1px solid #2c2c2c; vertical-align:middle; }
.empty { text-align:center; padding:16px; color:#888; }
.filters { margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; }
th.sortable { cursor:pointer; }
.stats { display:flex; gap:16px; margin-bottom:10px; flex-wrap:wrap; }
.stat-box { background:#1e1e1e; padding:10px 16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.6); font-size:0.8rem; }
.stat-box span { font-weight:bold; color:#90caf9; }
.stat-box.clickable { cursor:pointer; transition:background 0.2s; }
.stat-box.clickable:hover { background:#2a2a2a; }
button { margin-top:10px; padding:6px 12px; background:#90caf9; color:#121212; border:none; border-radius:6px; cursor:pointer; }
.green-dot {
  display: inline-block;
  width: 10px;
  height: 10px;
  background: #4caf50;
  border-radius: 50%;
  margin-right: 6px;
}
#sentChart { width: 100%; height: 350px; }

/* Chart Checkboxes */
.chart-controls { 
  display: flex; 
  gap: 16px; 
  margin-bottom: 12px; 
  flex-wrap: wrap;
}
.chart-checkbox {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  user-select: none;
}
.chart-checkbox input[type="checkbox"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}
.chart-checkbox.c-blue input[type="checkbox"] { accent-color: #90caf9; }
.chart-checkbox.c-green input[type="checkbox"] { accent-color: #4caf50; }
.chart-checkbox.c-orange input[type="checkbox"] { accent-color: #ff9800; }
.chart-checkbox.c-purple input[type="checkbox"] { accent-color: #ab47bc; }
.chart-checkbox.c-cyan input[type="checkbox"] { accent-color: #26c6da; }

.chart-checkbox label {
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  color: #e0e0e0;
}
</style>
</head>
<body>

<h1>Kecoaxx Dashboard</h1>

<div class="stats">
<div class="stat-box">
  <span class="green-dot"></span>
  Active Devices: <span id="stat-active">0</span>
</div>
  <div class="stat-box clickable" id="total-sent-box" title="Klik untuk lihat history">
    Total Sent: <span id="stat-sent">0</span>
  </div>
  <div class="stat-box">Total API: <span id="stat-totalapi">0</span></div>
</div>

<div class="filters">
  <input type="text" id="searchInput" placeholder="Cari nama, app, atau versi..." />
  <select id="timeRange">
    <option value="today">Hari ini</option>
    <option value="all">Semua</option>
  </select>
  <select id="statusFilter">
    <option value="active">Show Active</option>
    <option value="inactive">Show Inactive</option>
    <option value="all">Show All</option>
  </select>
  <button id="refreshBtn">Refresh Data</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Nama</th>
        <th class="sortable">Sent ▲▼</th>
        <th>Device</th>
        <th>Bot</th>
        <th>App</th>
        <th>API Ranges</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="devices-table">
      <tr><td colspan="7" class="empty">Loading data...</td></tr>
    </tbody>
  </table>
</div>

<br><br><div id="history-section">-- Stats --</div><br>

<div class="chart-controls">
  <div class="chart-checkbox c-blue">
    <input type="checkbox" id="check-total-sent">
    <label for="check-total-sent">Total Sent</label>
  </div>
  <div class="chart-checkbox c-green">
    <input type="checkbox" id="check-avg-device" checked>
    <label for="check-avg-device">Avg per Device</label>
  </div>
  <div class="chart-checkbox c-orange">
    <input type="checkbox" id="check-daily-growth">
    <label for="check-daily-growth">Daily Growth %</label>
  </div>
  <div class="chart-checkbox c-purple">
    <input type="checkbox" id="check-efficiency-growth">
    <label for="check-efficiency-growth">Efficiency Growth %</label>
  </div>
  <div class="chart-checkbox c-cyan">
    <input type="checkbox" id="check-active-devices">
    <label for="check-active-devices">Active Devices</label>
  </div>
</div>

<div id="sentChart"></div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBWrIDwTn4Byd9gZdYeGtwVUe0q2f2KYT4",
  authDomain: "kecoaxx-db898.firebaseapp.com",
  databaseURL: "https://kecoaxx-db898-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kecoaxx-db898",
  storageBucket: "kecoaxx-db898.firebasestorage.app",
  messagingSenderId: "929070876762",
  appId: "1:929070876762:web:696c8699f91e8022cc7063"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const devicesRef = ref(db, "devices");
const sentHistoryRef = ref(db, "sentHistory");
const apiKeysRef = ref(db, "apiKeys/list");
// DOM
const searchInput = document.getElementById("searchInput");
const timeRange = document.getElementById("timeRange");
const statusFilter = document.getElementById("statusFilter");
const table = document.getElementById("devices-table");
const statActive = document.getElementById("stat-active");
const statSent = document.getElementById("stat-sent");
const statTotalApi = document.getElementById("stat-totalapi");

// Table & Sorting
let devicesData = [];
let sortSentAsc = false;

// Render Table
function renderTable() {
  table.innerHTML = "";
  let filtered = devicesData.filter(d => {
    const searchTerm = searchInput.value.toLowerCase();
    const name = (d.botName || "").toLowerCase();
    const app = (d.pkgName || "").toLowerCase();
    const version = (d.appVersion || "").toLowerCase();
    
    return name.includes(searchTerm) || app.includes(searchTerm) || version.includes(searchTerm);
  });
  
  filtered = filtered.filter(d => {
    const sent = timeRange.value === "today" ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
    const isActive = sent > 0;
    
    if (statusFilter.value === "active") return isActive;
    if (statusFilter.value === "inactive") return !isActive;
    return true;
  });
  
  filtered.sort((a, b) => {
    const valA = timeRange.value === "today" ? (a.sentToday ?? 0) : (a.totalSent ?? 0);
    const valB = timeRange.value === "today" ? (b.sentToday ?? 0) : (b.totalSent ?? 0);
    return valB - valA;
  });
  
  filtered.forEach(d => {
    let sent = timeRange.value === "today" ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
    const rangeStart = d.rangeStart !== undefined ? d.rangeStart : "-";
    const rangeEnd = d.rangeEnd !== undefined ? d.rangeEnd : "-";
    const rangeDisplay = (rangeStart !== "-" && rangeEnd !== "-") ? `${rangeStart}-${rangeEnd}` : "-";
    const val = v => v ? v : "-";
    
    table.innerHTML += `
      <tr>
        <td>${val(d.botName)}</td>
        <td>${val(sent)}</td>
        <td>${val(d.deviceName || d.id)}</td>
        <td>${val(d.appVersion ? "v." + d.appVersion : "")}</td>
        <td>${val(d.pkgName)}</td>
        <td>${val(rangeDisplay)}</td>
        <td>${val(d.status)}</td>
      </tr>`;
  });
  if (filtered.length === 0) table.innerHTML = `<tr><td colspan="7" class="empty">Tidak ada data</td></tr>`;
}

// Fetch Devices
async function fetchDevices() {
  try {
    const snapshot = await get(devicesRef);
    devicesData = [];
    let totalSent = 0, activeCount = 0;

    snapshot.forEach(child => {
      const d = child.val();
      d.id = child.key;

      let sentValue = 0;
      if (timeRange.value === "today" && d.hasOwnProperty('sentToday')) sentValue = d.sentToday;
      else if (timeRange.value === "all" && d.hasOwnProperty('totalSent')) sentValue = d.totalSent;

      if (sentValue > 0) activeCount++;
      totalSent += sentValue;
      d._sentValue = sentValue;
      devicesData.push(d);
    });

    statActive.textContent = activeCount;
    statSent.textContent = totalSent;
    renderTable();
  } catch (err) {
    console.error("Error devices:", err);
    table.innerHTML = `<tr><td colspan="7" class="empty">Error ambil data</td></tr>`;
  }
}

async function fetchApiKeysCount() {
  try {
    const snapshot = await get(apiKeysRef);
    let apiCount = 0;
    snapshot.forEach(() => { apiCount++; });
    statTotalApi.textContent = apiCount;
  } catch (err) {
    console.error("Error API keys:", err);
    statTotalApi.textContent = "0";
  }
}

// Store chart data globally
let chartData = {
  labels: [],
  totalSentData: [],
  avgPerDeviceData: [],
  dailyGrowthData: [],
  efficiencyGrowthData: [],
  activeDevicesData: []
};

// Fetch Sent History
async function fetchSentHistory() {
  try {
    const snapshot = await get(sentHistoryRef);
    const allDates = [];
    snapshot.forEach(child => { 
      const data = child.val();
      allDates.push({ 
        date: child.key, 
        totalSent: data.totalSent ?? 0,
        activeDevices: data.activeDevices ?? 0
      }); 
    });
    
    // Sort by date
    allDates.sort((a, b) => a.date.localeCompare(b.date));
    
    chartData.labels = allDates.map(d => d.date);
    chartData.totalSentData = allDates.map(d => d.totalSent);
    chartData.activeDevicesData = allDates.map(d => d.activeDevices);
    chartData.avgPerDeviceData = allDates.map(d => {
      return d.activeDevices > 0 ? parseFloat((d.totalSent / d.activeDevices).toFixed(2)) : 0;
    });

    // Calculate Daily Growth % (Total Sent)
    chartData.dailyGrowthData = allDates.map((d, i) => {
      if (i === 0) return 0;
      const prev = allDates[i - 1].totalSent;
      if (prev === 0) return 0;
      return parseFloat((((d.totalSent - prev) / prev) * 100).toFixed(2));
    });

    // Calculate Efficiency Growth % (Avg per Device)
    chartData.efficiencyGrowthData = allDates.map((d, i) => {
      if (i === 0) return 0;
      const currAvg = d.activeDevices > 0 ? d.totalSent / d.activeDevices : 0;
      const prevAvg = allDates[i - 1].activeDevices > 0 ? allDates[i - 1].totalSent / allDates[i - 1].activeDevices : 0;
      if (prevAvg === 0) return 0;
      return parseFloat((((currAvg - prevAvg) / prevAvg) * 100).toFixed(2));
    });

    updateChart();
  } catch (err) {
    console.error("Error history:", err);
  }
}

// Update chart based on checkboxes
function updateChart() {
  const showTotalSent = document.getElementById('check-total-sent').checked;
  const showAvgDevice = document.getElementById('check-avg-device').checked;
  const showDailyGrowth = document.getElementById('check-daily-growth').checked;
  const showEfficiencyGrowth = document.getElementById('check-efficiency-growth').checked;
  const showActiveDevices = document.getElementById('check-active-devices').checked;
  
  const traces = [];
  const yaxisConfig = {};
  let yaxisCounter = 1;

  // Helper to get next yaxis
  const getYAxis = () => {
    if (yaxisCounter === 1) {
      yaxisCounter++;
      return 'y';
    }
    const axis = `y${yaxisCounter}`;
    yaxisCounter++;
    return axis;
  };
  
  if (showTotalSent) {
    traces.push({
      x: chartData.labels,
      y: chartData.totalSentData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Total Sent',
      yaxis: getYAxis(),
      line: { color: '#90caf9', width: 2, shape: 'spline' },
      marker: { color: '#90caf9', size: 5 }
    });
  }

  if (showAvgDevice) {
    traces.push({
      x: chartData.labels,
      y: chartData.avgPerDeviceData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Avg per Device',
      yaxis: getYAxis(),
      line: { color: '#4caf50', width: 2, shape: 'spline' },
      marker: { color: '#4caf50', size: 5 }
    });
  }

  if (showDailyGrowth) {
    traces.push({
      x: chartData.labels,
      y: chartData.dailyGrowthData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Daily Growth %',
      yaxis: getYAxis(),
      line: { color: '#ff9800', width: 2, shape: 'spline' },
      marker: { color: '#ff9800', size: 5 }
    });
  }

  if (showEfficiencyGrowth) {
    traces.push({
      x: chartData.labels,
      y: chartData.efficiencyGrowthData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Efficiency Growth %',
      yaxis: getYAxis(),
      line: { color: '#ab47bc', width: 2, shape: 'spline' },
      marker: { color: '#ab47bc', size: 5 }
    });
  }

  if (showActiveDevices) {
    traces.push({
      x: chartData.labels,
      y: chartData.activeDevicesData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Active Devices',
      yaxis: getYAxis(),
      line: { color: '#26c6da', width: 2, shape: 'spline' },
      marker: { color: '#26c6da', size: 5 }
    });
  }

  const layout = {
    paper_bgcolor: '#121212',
    plot_bgcolor: '#1e1e1e',
    font: { color: '#e0e0e0' },
    xaxis: {
      gridcolor: 'rgba(255,255,255,0.1)',
      showgrid: true,
      color: '#fff'
    },
    yaxis: {
      gridcolor: 'rgba(255,255,255,0.1)',
      showgrid: true,
      color: '#fff'
    },
    margin: { l: 50, r: 50, t: 20, b: 50 },
    hovermode: 'x unified',
    dragmode: 'pan',
    showlegend: false
  };

  // Add additional y-axes if multiple metrics selected
  const colors = ['#90caf9', '#4caf50', '#ff9800', '#ab47bc', '#26c6da'];
  let colorIdx = 0;
  
  traces.forEach((trace, idx) => {
    if (idx > 0 && trace.yaxis !== 'y') {
      const yaxisNum = trace.yaxis.replace('y', '');
      layout[`yaxis${yaxisNum}`] = {
        overlaying: 'y',
        side: idx % 2 === 0 ? 'right' : 'left',
        position: idx > 2 ? (idx % 2 === 0 ? 0.95 - (idx * 0.05) : 0.05 + (idx * 0.05)) : undefined,
        color: colors[colorIdx % colors.length],
        showgrid: false
      };
      colorIdx++;
    }
  });

  const config = {
    responsive: true,
    displayModeBar: true,
    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
    scrollZoom: true,
    displaylogo: false
  };

  Plotly.newPlot('sentChart', traces, layout, config);
}

// Checkbox events
document.getElementById('check-total-sent').addEventListener('change', updateChart);
document.getElementById('check-avg-device').addEventListener('change', updateChart);
document.getElementById('check-daily-growth').addEventListener('change', updateChart);
document.getElementById('check-efficiency-growth').addEventListener('change', updateChart);
document.getElementById('check-active-devices').addEventListener('change', updateChart);

// Manual refresh
async function refreshAll() {
  await fetchDevices();
  await fetchApiKeysCount();
  await fetchSentHistory();
}

// Init
refreshAll();

// Button event
document.getElementById("refreshBtn").addEventListener("click", refreshAll);

// Click Total Sent box to scroll to history
document.getElementById("total-sent-box").addEventListener("click", () => {
  document.getElementById("history-section").scrollIntoView({ behavior: "smooth", block: "start" });
});

// Filters
[searchInput, timeRange, statusFilter].forEach(el => el.addEventListener("change", renderTable));
searchInput.addEventListener("input", renderTable);

// Sort column
document.querySelector("th.sortable").addEventListener("click", () => {
  devicesData.sort((a, b) => {
    const valA = timeRange.value === "today" ? (a.sentToday ?? 0) : (a.totalSent ?? 0);
    const valB = timeRange.value === "today" ? (b.sentToday ?? 0) : (b.totalSent ?? 0);
    return sortSentAsc ? valB - valA : valA - valB;
  });
  sortSentAsc = !sortSentAsc;
  renderTable();
});
</script>
<footer style="text-align:center; padding:12px; font-size:0.75rem; color:#777; margin-top:20px;">
  Powered by <span style="color:#90caf9;">mencretsu</span>
</footer>
</body>
</html>
