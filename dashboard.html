<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kecoaxx Leaderboard</title>
<style>
/* Previous CSS styles tetap sama... */

.chart-section {
  background: #1e1e2e;
  padding: 20px;
  border-radius: 12px;
  margin-top: 30px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.6);
  position: relative;
}
.chart-title {
  font-size: 1.2rem;
  font-weight: 600;
  color: #90caf9;
  margin-bottom: 16px;
  text-align: center;
}
.chart-wrapper {
  position: relative;
  height: 300px; /* Fixed height biar ga kegedean */
  width: 100%;
}
canvas { 
  display: block;
  max-width: 100%;
  max-height: 100%;
}

/* Tambahan buat chart controls */
.chart-controls {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 15px;
  flex-wrap: wrap;
}
.chart-controls button {
  padding: 8px 16px;
  font-size: 0.8rem;
  background: rgba(144, 202, 249, 0.2);
  color: #90caf9;
  border: 1px solid #90caf9;
}
.chart-controls button:hover {
  background: rgba(144, 202, 249, 0.3);
}
</style>
</head>
<body>

<h1>üèÜ Kecoaxx Leaderboard</h1>

<div class="stats">
  <div class="stat-box">
    <div class="label"><span class="green-dot"></span>Active</div>
    <div class="value" id="stat-active">0</div>
  </div>
  <div class="stat-box">
    <div class="label">Total Sent</div>
    <div class="value" id="stat-sent">0</div>
  </div>
  <div class="stat-box">
    <div class="label">Total API</div>
    <div class="value" id="stat-totalapi">0</div>
  </div>
</div>

<div class="filters">
  <input type="text" id="searchInput" placeholder="üîç Cari nama, app, atau versi..." />
  <select id="timeRange">
    <option value="today">Hari ini</option>
    <option value="all">Semua</option>
  </select>
  <select id="statusFilter">
    <option value="active">Show Active</option>
    <option value="inactive">Show Inactive</option>
    <option value="all">Show All</option>
  </select>
  <button id="refreshBtn">üîÑ Refresh Data</button>
</div>

<!-- Desktop Table -->
<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Rank</th>
        <th>Nama</th>
        <th class="sortable">Sent ‚ñ≤‚ñº</th>
        <th>Device</th>
        <th>Bot</th>
        <th>App</th>
        <th>API Ranges</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="devices-table">
      <tr><td colspan="8" class="empty">Loading data...</td></tr>
    </tbody>
  </table>
</div>

<!-- Mobile Cards -->
<div class="cards-container" id="devices-cards">
  <div class="empty">Loading data...</div>
</div>

<div class="chart-section">
  <div class="chart-title">üìä Sent History Stats</div>
  <div class="chart-wrapper">
    <canvas id="sentChart"></canvas>
  </div>
  <div class="chart-controls">
    <button id="resetZoom">Reset Zoom</button>
    <button id="toggleAnimation">Pause Animation</button>
    <button id="exportChart">Export Chart</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0/dist/chartjs-plugin-zoom.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWrIDwTn4Byd9gZdYeGtwVUe0q2f2KYT4",
  authDomain: "kecoaxx-db898.firebaseapp.com",
  databaseURL: "https://kecoaxx-db898-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kecoaxx-db898",
  storageBucket: "kecoaxx-db898.firebasestorage.app",
  messagingSenderId: "929070876762",
  appId: "1:929070876762:web:696c8699f91e8022cc7063"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const devicesRef = ref(db, "devices");
const sentHistoryRef = ref(db, "sentHistory");
const apiKeysRef = ref(db, "apiKeys/list");

// DOM elements
const searchInput = document.getElementById("searchInput");
const timeRange = document.getElementById("timeRange");
const statusFilter = document.getElementById("statusFilter");
const table = document.getElementById("devices-table");
const cardsContainer = document.getElementById("devices-cards");
const statActive = document.getElementById("stat-active");
const statSent = document.getElementById("stat-sent");
const statTotalApi = document.getElementById("stat-totalapi");

let devicesData = [];
let sortSentAsc = false;
let chartAnimationEnabled = true;

function getMedalIcon(rank) {
  if (rank === 1) return '<span class="medal">ü•á</span>';
  if (rank === 2) return '<span class="medal">ü•à</span>';
  if (rank === 3) return '<span class="medal">ü•â</span>';
  return '';
}

function renderTable() {
  table.innerHTML = "";
  cardsContainer.innerHTML = "";
  
  let filtered = devicesData.filter(d => {
    const searchTerm = searchInput.value.toLowerCase();
    const name = (d.botName || "").toLowerCase();
    const app = (d.pkgName || "").toLowerCase();
    const version = (d.appVersion || "").toLowerCase();
    return name.includes(searchTerm) || app.includes(searchTerm) || version.includes(searchTerm);
  });
  
  filtered = filtered.filter(d => {
    const sent = timeRange.value === "today" ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
    const isActive = sent > 0;
    if (statusFilter.value === "active") return isActive;
    if (statusFilter.value === "inactive") return !isActive;
    return true;
  });
  
  filtered.sort((a, b) => {
    const valA = timeRange.value === "today" ? (a.sentToday ?? 0) : (a.totalSent ?? 0);
    const valB = timeRange.value === "today" ? (b.sentToday ?? 0) : (b.totalSent ?? 0);
    return valB - valA;
  });
  
  filtered.forEach((d, index) => {
    const rank = index + 1;
    let sent = timeRange.value === "today" ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
    
    const rangeStart = d.rangeStart !== undefined ? d.rangeStart : "-";
    const rangeEnd = d.rangeEnd !== undefined ? d.rangeEnd : "-";
    const rangeDisplay = (rangeStart !== "-" && rangeEnd !== "-") ? `${rangeStart}-${rangeEnd}` : "-";
    
    const val = v => v ? v : "-";
    const rankClass = `rank-${rank <= 20 ? rank : 'default'}`;
    const medalIcon = getMedalIcon(rank);
    
    // Table row
    table.innerHTML += `
      <tr class="${rankClass}">
        <td class="rank-cell">${medalIcon}#${rank}</td>
        <td>${val(d.botName)}</td>
        <td><strong>${val(sent)}</strong></td>
        <td>${val(d.deviceName || d.id)}</td>
        <td>${val(d.appVersion ? "v." + d.appVersion : "")}</td>
        <td>${val(d.pkgName)}</td>
        <td>${val(rangeDisplay)}</td>
        <td>${val(d.status)}</td>
      </tr>`;
    
    // Mobile card
    cardsContainer.innerHTML += `
      <div class="device-card ${rankClass}">
        <div class="card-header">
          <div class="card-rank">${medalIcon}#${rank}</div>
          <div class="card-name">${val(d.botName)}</div>
          <div class="card-sent">${val(sent)}</div>
        </div>
        <div class="card-details">
          <div class="card-detail">
            <div class="card-detail-label">Device</div>
            <div class="card-detail-value">${val(d.deviceName || d.id)}</div>
          </div>
          <div class="card-detail">
            <div class="card-detail-label">Bot Ver</div>
            <div class="card-detail-value">${val(d.appVersion ? "v." + d.appVersion : "")}</div>
          </div>
          <div class="card-detail">
            <div class="card-detail-label">App</div>
            <div class="card-detail-value">${val(d.pkgName)}</div>
          </div>
          <div class="card-detail">
            <div class="card-detail-label">API Range</div>
            <div class="card-detail-value">${val(rangeDisplay)}</div>
          </div>
          <div class="card-detail">
            <div class="card-detail-label">Status</div>
            <div class="card-detail-value">${val(d.status)}</div>
          </div>
        </div>
      </div>`;
  });
  
  if (filtered.length === 0) {
    table.innerHTML = `<tr><td colspan="8" class="empty">Tidak ada data ditemukan</td></tr>`;
    cardsContainer.innerHTML = `<div class="empty">Tidak ada data ditemukan</div>`;
  }
}

async function fetchDevices() {
  try {
    const snapshot = await get(devicesRef);
    devicesData = [];
    let totalSent = 0, activeCount = 0;

    snapshot.forEach(child => {
      const d = child.val();
      d.id = child.key;

      let sentValue = 0;
      if (timeRange.value === "today" && d.hasOwnProperty('sentToday')) sentValue = d.sentToday;
      else if (timeRange.value === "all" && d.hasOwnProperty('totalSent')) sentValue = d.totalSent;

      if (sentValue > 0) activeCount++;
      totalSent += sentValue;

      d._sentValue = sentValue;
      devicesData.push(d);
    });

    statActive.textContent = activeCount;
    statSent.textContent = totalSent;
    renderTable();
  } catch (err) {
    console.error("Error devices:", err);
    table.innerHTML = `<tr><td colspan="8" class="empty">Error loading data</td></tr>`;
    cardsContainer.innerHTML = `<div class="empty">Error loading data</div>`;
  }
}

async function fetchApiKeysCount() {
  try {
    const snapshot = await get(apiKeysRef);
    let apiCount = 0;
    snapshot.forEach(() => apiCount++);
    statTotalApi.textContent = apiCount;
  } catch (err) {
    console.error("Error API keys:", err);
    statTotalApi.textContent = "0";
  }
}

const ctx = document.getElementById("sentChart").getContext("2d");
let sentChart = null;

async function fetchSentHistory() {
  try {
    const snapshot = await get(sentHistoryRef);
    const allDates = [];
    snapshot.forEach(child => { 
      allDates.push({ date: child.key, total: child.val().totalSent ?? 0 }); 
    });
    
    // Sort dates chronologically
    allDates.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // Ambil hanya 30 data terakhir biar ga terlalu penuh
    const recentDates = allDates.slice(-30);
    
    const labels = recentDates.map(d => {
      const date = new Date(d.date);
      return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
    });
    const dataPoints = recentDates.map(d => d.total);

    if (sentChart) sentChart.destroy();

    sentChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: "Total Sent",
          data: dataPoints,
          fill: true,
          borderColor: "#90caf9",
          backgroundColor: "rgba(144,202,249,0.3)",
          tension: 0.4,
          pointRadius: 3,
          pointHoverRadius: 5,
          pointBackgroundColor: "#90caf9",
          pointBorderColor: "#0a0a0a",
          pointBorderWidth: 2,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: chartAnimationEnabled ? 1000 : 0
        },
        plugins: {
          legend: { 
            display: true,
            labels: { 
              color: "#fff",
              font: { size: 12, weight: 600 },
              boxWidth: 0
            } 
          },
          tooltip: { 
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(30, 30, 46, 0.95)',
            titleColor: '#90caf9',
            bodyColor: '#e0e0e0',
            borderColor: '#90caf9',
            borderWidth: 1,
            cornerRadius: 8,
            displayColors: false
          },
          zoom: {
            pan: { 
              enabled: true, 
              mode: 'x',
              modifierKey: 'ctrl'
            },
            zoom: {
              wheel: { enabled: true },
              pinch: { enabled: true },
              mode: 'x',
              limits: {
                x: { min: 0, max: labels.length - 1 },
                y: { min: 0 }
              }
            }
          }
        },
        interaction: { 
          mode: 'nearest', 
          axis: 'x', 
          intersect: false 
        },
        scales: {
          x: { 
            ticks: { 
              color: "#aaa",
              maxRotation: 45,
              minRotation: 45,
              font: { size: 10 }
            }, 
            grid: { 
              color: "rgba(255,255,255,0.1)",
              drawBorder: false
            },
            title: {
              display: true,
              text: 'Date',
              color: '#90caf9'
            }
          },
          y: { 
            ticks: { 
              color: "#aaa",
              font: { size: 10 }
            }, 
            grid: { 
              color: "rgba(255,255,255,0.1)",
              drawBorder: false
            },
            title: {
              display: true,
              text: 'Total Sent',
              color: '#90caf9'
            },
            beginAtZero: true
          }
        },
        layout: {
          padding: {
            top: 10,
            right: 10,
            bottom: 10,
            left: 10
          }
        }
      }
    });
  } catch (err) {
    console.error("Error history:", err);
  }
}

// Manual refresh
async function refreshAll() {
  await fetchDevices();
  await fetchApiKeysCount();
  await fetchSentHistory();
}

// Auto-refresh every 30 seconds
setInterval(refreshAll, 30000);

// Initialize
refreshAll();

// Event listeners
document.getElementById("refreshBtn").addEventListener("click", refreshAll);
document.getElementById("resetZoom").addEventListener("click", () => { 
  if (sentChart) sentChart.resetZoom(); 
});

// Toggle animation
document.getElementById("toggleAnimation").addEventListener("click", function() {
  chartAnimationEnabled = !chartAnimationEnabled;
  this.textContent = chartAnimationEnabled ? 'Pause Animation' : 'Play Animation';
  if (sentChart) {
    sentChart.destroy();
    fetchSentHistory();
  }
});

// Export chart
document.getElementById("exportChart").addEventListener("click", function() {
  if (sentChart) {
    const link = document.createElement('a');
    link.download = 'kecoaxx-chart.png';
    link.href = sentChart.toBase64Image();
    link.click();
  }
});

// Filters
[searchInput, timeRange, statusFilter].forEach(el => {
  el.addEventListener("change", renderTable);
});
searchInput.addEventListener("input", renderTable);

// Sort column
document.querySelector("th.sortable").addEventListener("click", () => {
  devicesData.sort((a, b) => {
    const valA = timeRange.value === "today" ? (a.sentToday ?? 0) : (a.totalSent ?? 0);
    const valB = timeRange.value === "today" ? (b.sentToday ?? 0) : (b.totalSent ?? 0);
    return sortSentAsc ? valB - valA : valA - valB;
  });
  sortSentAsc = !sortSentAsc;
  renderTable();
});

// Responsive check
function checkResponsive() {
  const isMobile = window.innerWidth <= 768;
  if (isMobile) {
    document.querySelector('.table-container').style.display = 'none';
    document.querySelector('.cards-container').style.display = 'block';
  } else {
    document.querySelector('.table-container').style.display = 'block';
    document.querySelector('.cards-container').style.display = 'none';
  }
}

window.addEventListener('resize', checkResponsive);
checkResponsive(); // Initial check
</script>

<footer>
  Powered by <span>mencretsu</span> | Kecoaxx Leaderboard v2.0
</footer>

</body>
</html>
