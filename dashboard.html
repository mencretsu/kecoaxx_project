<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kecoaxx Dashboard</title>
<style>
body { font-family:"Roboto", sans-serif; background:#121212; color:#e0e0e0; margin:0; padding:10px; }
h1 { text-align:center; margin:10px 0 18px 0; font-size:1.4rem; color:#fff; }
.table-container { overflow-x:auto; margin-bottom:10px; }
table { width:100%; min-width:350px; border-collapse:collapse; background:#1e1e1e; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.6); font-size:0.7rem; }
thead { background:#272727; }
th, td { padding:6px 10px; text-align:left; cursor:default; }
th { color:#90caf9; font-weight:480; border-bottom:1px solid #333; white-space:nowrap; }
tr:nth-child(even) { background:#2a2a2a; }
tr:hover { background:#333; }
td { border-bottom:1px solid #2c2c2c; vertical-align:middle; }
.empty { text-align:center; padding:16px; color:#888; }
.filters { margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; }
th.sortable { cursor:pointer; }
.stats { display:flex; gap:16px; margin-bottom:10px; flex-wrap:wrap; }
.stat-box { background:#1e1e1e; padding:10px 16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.6); font-size:0.8rem; }
.stat-box span { font-weight:bold; color:#90caf9; }
canvas { display:block; max-width:100%; }
button { margin-top:10px; padding:6px 12px; background:#90caf9; color:#121212; border:none; border-radius:6px; cursor:pointer; }
</style>
</head>
<body>

<h1>Kecoaxx Dashboard</h1>

<div class="stats">
  <div class="stat-box">Active Devices: <span id="stat-active">0</span></div>
  <div class="stat-box">Total Sent: <span id="stat-sent">0</span></div>
</div>

<div class="filters">
  <input type="text" id="searchName" placeholder="Cari nama..." />
  <select id="timeRange">
    <option value="today">Hari ini</option>
    <option value="all">Semua</option>
  </select>
  <select id="limit">
    <option value="all">Semua</option>
    <option value="10">10</option>
    <option value="20">20</option>
  </select>
  <button id="refreshBtn">Refresh Data</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Nama</th>
        <th class="sortable">Sent ▲▼</th>
        <th>Device</th>
        <th>Bot</th>
        <th>App</th>
        <th>Status</th>
        <th>Range</th>
      </tr>
    </thead>
    <tbody id="devices-table">
      <tr><td colspan="7" class="empty">Loading data...</td></tr>
    </tbody>
  </table>
</div>

<br><br>-- Stats --<br>
<div style="overflow-x:auto;">
  <canvas id="sentChart" height="200"></canvas>
</div>
<button id="resetZoom">Reset Zoom</button>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0/dist/chartjs-plugin-zoom.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBWrIDwTn4Byd9gZdYeGtwVUe0q2f2KYT4",
  authDomain: "kecoaxx-db898.firebaseapp.com",
  databaseURL: "https://kecoaxx-db898-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kecoaxx-db898",
  storageBucket: "kecoaxx-db898.firebasestorage.app",
  messagingSenderId: "929070876762",
  appId: "1:929070876762:web:696c8699f91e8022cc7063"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const devicesRef = ref(db, "devices");
const sentHistoryRef = ref(db, "sentHistory");

// DOM
const searchName = document.getElementById("searchName");
const timeRange = document.getElementById("timeRange");
const limit = document.getElementById("limit");
const table = document.getElementById("devices-table");
const statActive = document.getElementById("stat-active");
const statSent = document.getElementById("stat-sent");

// Table & Sorting
let devicesData = [];
let sortSentAsc = true;

// Render Table
function renderTable() {
  table.innerHTML = "";
  let filtered = devicesData.filter(d => (d.botName || "").toLowerCase().includes(searchName.value.toLowerCase()));
  let lim = limit.value === "all" ? filtered.length : parseInt(limit.value);
  filtered.slice(0, lim).forEach(d => {
    let sent = timeRange.value === "today" ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
    table.innerHTML += `<tr>
      <td>${d.botName || "-"}</td>
      <td>${sent}</td>
      <td>${d.deviceName || d.id}</td>
      <td>${d.appVersion ? `v.${d.appVersion}` : "-"}</td>
      <td>${d.pkgName || "-"}</td>
      <td>${d.status || "-"}</td>
      <td>${d.apiStart || "-"} - ${d.apiEnd || "-"}</td>
    </tr>`;
  });
  if (filtered.length === 0) table.innerHTML = `<tr><td colspan="7" class="empty">Tidak ada data</td></tr>`;
}

// Fetch Devices
async function fetchDevices() {
  try {
    const snapshot = await get(devicesRef);
    devicesData = [];
    let totalSent = 0, activeCount = 0;
    snapshot.forEach(child => {
      const d = child.val(); d.id = child.key;
      const sent = timeRange.value === "today" ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
      if (sent > 0) activeCount++;
      totalSent += sent;
      devicesData.push(d);
    });
    statActive.textContent = activeCount;
    statSent.textContent = totalSent;
    renderTable();
  } catch (err) {
    console.error("Error devices:", err);
    table.innerHTML = `<tr><td colspan="7" class="empty">Error ambil data</td></tr>`;
  }
}

// Fetch Sent History
const ctx = document.getElementById("sentChart").getContext("2d");
let sentChart = null;
async function fetchSentHistory() {
  try {
    const snapshot = await get(sentHistoryRef);
    const allDates = [];
    snapshot.forEach(child => { allDates.push({ date: child.key, total: child.val().totalSent ?? 0 }); });
    const labels = allDates.map(d => d.date);
    const dataPoints = allDates.map(d => d.total);
    if (sentChart) sentChart.destroy();
    sentChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: "History",
          data: dataPoints,
          fill: true,
          borderColor: "#90caf9",
          backgroundColor: "rgba(144,202,249,0.2)",
          tension: 0.3,
          pointRadius: 4,
          pointHoverRadius: 6
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: "#fff" } },
          tooltip: { mode: 'index', intersect: false },
          zoom: {
            pan: { enabled: true, mode: 'x' },
            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
          }
        },
        interaction: { mode: 'nearest', axis: 'x', intersect: false },
        scales: { x: { ticks: { color: "#fff" } }, y: { ticks: { color: "#fff" }, beginAtZero: true } }
      }
    });
  } catch (err) {
    console.error("Error history:", err);
  }
}

// Manual refresh
async function refreshAll() {
  await fetchDevices();
  await fetchSentHistory();
}

// Init
refreshAll();

// Button event
document.getElementById("refreshBtn").addEventListener("click", refreshAll);
document.getElementById("resetZoom").addEventListener("click", () => { if (sentChart) sentChart.resetZoom(); });

// Filters
[searchName, timeRange, limit].forEach(el => el.addEventListener("input", renderTable));

// Sort column
document.querySelector("th.sortable").addEventListener("click", () => {
  devicesData.sort((a, b) => {
    const valA = timeRange.value === "today" ? (a.sentToday ?? 0) : (a.totalSent ?? 0);
    const valB = timeRange.value === "today" ? (b.sentToday ?? 0) : (b.totalSent ?? 0);
    return sortSentAsc ? valB - valA : valA - valB;
  });
  sortSentAsc = !sortSentAsc;
  renderTable();
});
</script>

</body>
</html>
