<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kecoaxx Dashboard</title>
<style>
body { font-family:"Roboto", sans-serif; background:#121212; color:#e0e0e0; margin:0; padding:8px; }
h1 { text-align:center; margin:8px 0 12px 0; font-size:1.2rem; color:#fff; }

/* User Header Styles */
.user-section { margin-bottom: 12px; }
.user-header {
  background: linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%);
  padding: 12px 16px;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: all 0.2s ease;
  border-left: 4px solid #90caf9;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.user-header:hover { background: linear-gradient(135deg, #2a2a2a 0%, #333 100%); transform: translateX(2px); }
.user-header.collapsed { border-left-color: #555; }

.user-info { flex: 1; }
.user-name { font-size: 1rem; font-weight: 600; color: #90caf9; margin-bottom: 4px; }
.user-stats { font-size: 0.7rem; color: #aaa; display: flex; gap: 16px; flex-wrap: wrap; }
.user-stats span { display: inline-flex; align-items: center; gap: 4px; }
.user-stats .label { opacity: 0.7; }
.user-stats .value { color: #4caf50; font-weight: 600; }

.expand-icon { 
  font-size: 1.2rem; 
  color: #90caf9; 
  transition: transform 0.3s ease;
  user-select: none;
}
.user-header.collapsed .expand-icon { transform: rotate(-90deg); }

/* Devices Table */
.devices-container {
  overflow: hidden;
  max-height: 2000px;
  transition: max-height 0.4s ease, opacity 0.3s ease;
  opacity: 1;
}
.devices-container.collapsed {
  max-height: 0;
  opacity: 0;
}

.table-container { overflow-x:auto; margin:8px 0; -webkit-overflow-scrolling:touch; }
table { width:100%; border-collapse:collapse; background:#1a1a1a; border-radius:6px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.6); font-size:0.7rem; }
thead { background:#252525; position:sticky; top:0; z-index:10; }
th, td { padding:6px 8px; text-align:left; }
th { color:#888; font-weight:480; border-bottom:1px solid #333; white-space:nowrap; font-size:0.65rem; text-transform: uppercase; letter-spacing: 0.5px; }
tr:nth-child(even) { background:#222; }
tr:hover { background:#2a2a2a; }
td { border-bottom:1px solid #2c2c2c; vertical-align:middle; font-size:0.68rem; }
.empty { text-align:center; padding:12px; color:#888; font-style: italic; }

/* Filters & Controls */
.filters { margin-bottom:12px; display:flex; gap:6px; flex-wrap:wrap; }
.filters input, .filters select { font-size:0.75rem; padding:6px 8px; background:#1e1e1e; color:#e0e0e0; border:1px solid #333; border-radius:4px; flex:1; min-width:100px; }
button { padding:6px 10px; background:#90caf9; color:#121212; border:none; border-radius:4px; cursor:pointer; font-size:0.75rem; font-weight: 600; transition: all 0.2s; }
button:hover { background:#64b5f6; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(144, 202, 249, 0.3); }
button:active { transform: translateY(0); }

/* Stats Cards */
.stats { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
.stat-box { background:linear-gradient(135deg, #1e1e1e 0%, #2a2a2a 100%); padding:10px 14px; border-radius:6px; box-shadow:0 2px 8px rgba(0,0,0,0.6); font-size:0.7rem; flex:1; min-width:90px; text-align:center; border-top: 2px solid #90caf9; }
.stat-box .label { font-size:0.65rem; opacity:0.7; margin-bottom:4px; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-box .value { font-weight:bold; color:#90caf9; display:block; font-size:0.9rem; margin-top:2px; }
.stat-box.clickable { cursor:pointer; transition:all 0.2s; }
.stat-box.clickable:hover { background:linear-gradient(135deg, #2a2a2a 0%, #333 100%); transform: translateY(-2px); box-shadow:0 4px 12px rgba(144, 202, 249, 0.3); }

/* Battery SVG */
.battery-container { display:inline-flex; align-items:center; justify-content:center; min-width:50px; }
.battery-svg { width:50px; height:25px; flex-shrink:0; }
.battery-svg.unknown { opacity:0.4; }
.battery-tooltip { position:relative; cursor:help; display:inline-block; }
.battery-tooltip:hover::after {
  content:attr(data-tooltip);
  position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
  background:#333; color:white; padding:4px 8px; border-radius:4px;
  font-size:0.7rem; white-space:nowrap; z-index:1000; margin-bottom:5px;
  pointer-events:none;
}

/* Range Badge */
.range-badge {
  display:inline-block; padding:2px 6px; background:#2a2a2a;
  border:1px solid #444; border-radius:4px; font-size:0.65rem;
  font-family:'Courier New', monospace; color:#90caf9; white-space:nowrap;
}
.range-badge.no-range { color:#777; border-color:#333; }

/* Chart Styles */
#sentChart { width:100%; height:280px; margin-top:12px; }
.chart-controls { 
  display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
  gap:8px; margin-bottom:10px;
}
.chart-checkbox { display:flex; align-items:center; gap:6px; cursor:pointer; user-select:none; }
.chart-checkbox input[type="checkbox"] { width:16px; height:16px; cursor:pointer; flex-shrink:0; }
.chart-checkbox.c-blue input[type="checkbox"] { accent-color:#90caf9; }
.chart-checkbox.c-green input[type="checkbox"] { accent-color:#4caf50; }
.chart-checkbox.c-orange input[type="checkbox"] { accent-color:#ff9800; }
.chart-checkbox.c-purple input[type="checkbox"] { accent-color:#ab47bc; }
.chart-checkbox.c-cyan input[type="checkbox"] { accent-color:#26c6da; }
.chart-checkbox label { cursor:pointer; font-size:0.75rem; font-weight:500; color:#e0e0e0; line-height:1.2; }

/* Loading State */
.loading { text-align:center; padding:24px; color:#888; }
.loading::after { content:'...'; animation:dots 1.5s steps(3, end) infinite; }
@keyframes dots {
  0%, 20% { content:''; }
  40% { content:'.'; }
  60% { content:'..'; }
  80%, 100% { content:'...'; }
}

/* Responsive */
@media (max-width: 768px) {
  body { padding:6px; }
  h1 { font-size:1.1rem; }
  .user-header { padding:10px 12px; }
  .user-name { font-size:0.9rem; }
  .user-stats { font-size:0.65rem; gap:10px; }
  table { font-size:0.65rem; }
  th, td { padding:5px 6px; }
  .stat-box { padding:8px 10px; min-width:80px; }
  #sentChart { height:240px; }
}

@media (max-width: 480px) {
  .user-header { flex-direction:column; align-items:flex-start; gap:8px; }
  .expand-icon { position:absolute; right:12px; top:12px; }
  .user-stats { gap:8px; }
  table { font-size:0.6rem; }
  th, td { padding:4px; }
  #sentChart { height:200px; }
}

  .warning-box {
  background: linear-gradient(135deg, #3d1f1f 0%, #5a2828 100%);
  border-left: 4px solid #f44336;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
}
.warning-box h3 {
  color: #f44336;
  margin: 0 0 12px 0;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 8px;
}
.warning-box ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
.warning-box li {
  padding: 8px;
  background: #2a2a2a;
  margin-bottom: 6px;
  border-radius: 4px;
  font-size: 0.75rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.warning-box .device-info {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.warning-box .device-name {
  color: #f44336;
  font-weight: 600;
}
.warning-box .device-meta {
  color: #888;
  font-size: 0.7rem;
}
.warning-box .last-sent {
  color: #ff9800;
  font-size: 0.7rem;
}
</style>
</head>
<body>

<h1>Kecoaxx Dashboard</h1>

<div class="stats">
  <div class="stat-box">
    <div class="label">Total Users</div>
    <span class="value" id="stat-users">0</span>
  </div>
  <div class="stat-box">
    <div class="label">Active Devices</div>
    <span class="value" id="stat-active">0</span>
  </div>
  <div class="stat-box clickable" id="total-sent-box" title="Klik untuk lihat history">
    <div class="label">Total Sent</div>
    <span class="value" id="stat-sent">0</span>
  </div>
  <div class="stat-box">
    <div class="label">Used APIs</div>
    <span class="value" id="stat-usedapi">0</span>
  </div>
  <div class="stat-box">
    <div class="label">Available Ranges</div>
    <span class="value" id="stat-availrange">0</span>
  </div>
</div>

<div class="filters">
  <input type="text" id="searchInput" placeholder="Cari username, bot, device..." />
  <select id="timeRange">
    <option value="today">Hari ini</option>
    <option value="all">Semua</option>
  </select>
  <select id="statusFilter">
    <option value="active">Show Active</option>
    <option value="inactive">Show Inactive</option>
    <option value="all">Show All</option>
  </select>
  <button id="expandAllBtn">Expand All</button>
  <button id="collapseAllBtn">Collapse All</button>
  <button id="refreshBtn">Refresh Data</button>
</div>

<div id="users-container">
  <div class="loading">Loading data</div>
</div>

<div id="history-section" style="text-align:center;font-weight:500;font-size:0.9rem;color:#90caf9;margin:24px 0 12px 0;">üìä Statistics</div>

<div class="chart-controls">
  <div class="chart-checkbox c-blue">
    <input type="checkbox" id="check-total-sent">
    <label for="check-total-sent">Total Sent</label>
  </div>
  <div class="chart-checkbox c-green">
    <input type="checkbox" id="check-avg-device" checked>
    <label for="check-avg-device">Avg per Device</label>
  </div>
  <div class="chart-checkbox c-orange">
    <input type="checkbox" id="check-daily-growth">
    <label for="check-daily-growth">Daily Growth %</label>
  </div>
  <div class="chart-checkbox c-purple">
    <input type="checkbox" id="check-efficiency-growth">
    <label for="check-efficiency-growth">Efficiency Growth %</label>
  </div>
  <div class="chart-checkbox c-cyan">
    <input type="checkbox" id="check-active-devices">
    <label for="check-active-devices">Active Devices</label>
  </div>
</div>

<div id="sentChart"></div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBWrIDwTn4Byd9gZdYeGtwVUe0q2f2KYT4",
  authDomain: "kecoaxx-db898.firebaseapp.com",
  databaseURL: "https://kecoaxx-db898-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kecoaxx-db898",
  storageBucket: "kecoaxx-db898.firebasestorage.app",
  messagingSenderId: "929070876762",
  appId: "1:929070876762:web:696c8699f91e8022cc7063"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const usersRef = ref(db, "users");
const keyRangesRef = ref(db, "keyRanges");
const sentHistoryRef = ref(db, "sentHistory");

const searchInput = document.getElementById("searchInput");
const timeRange = document.getElementById("timeRange");
const statusFilter = document.getElementById("statusFilter");
const usersContainer = document.getElementById("users-container");
const statUsers = document.getElementById("stat-users");
const statActive = document.getElementById("stat-active");
const statSent = document.getElementById("stat-sent");
const statUsedApi = document.getElementById("stat-usedapi");
const statAvailRange = document.getElementById("stat-availrange");

const TOTAL_POOL_KEYS = 2543;
const KEYS_PER_DEVICE = 10;
const TOTAL_RANGES = Math.floor(TOTAL_POOL_KEYS / KEYS_PER_DEVICE);

let usersData = {};
let keyRangesData = {};
let expandedUsers = new Set();

function renderBattery(batteryLevel) {
  if (batteryLevel === undefined || batteryLevel === null || batteryLevel < 0) {
    return `
      <div class="battery-tooltip" data-tooltip="Unknown">
        <div class="battery-container">
          <svg class="battery-svg unknown" viewBox="0 0 100 50">
            <rect x="5" y="10" width="75" height="30" rx="3" ry="3" fill="none" stroke="#666" stroke-width="2"/>
            <rect x="80" y="18" width="8" height="14" rx="2" ry="2" fill="#666"/>
            <text x="42.5" y="32" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#888" text-anchor="middle">?</text>
          </svg>
        </div>
      </div>
    `;
  }

  const clampedLevel = Math.max(0, Math.min(100, batteryLevel));
  const fillWidth = (clampedLevel / 100) * 69;
  
  let fillColor = "#4caf50";
  if (clampedLevel < 15) fillColor = "#d32f2f";
  else if (clampedLevel < 30) fillColor = "#f44336";
  else if (clampedLevel < 70) fillColor = "#ff9800";

  const fontSize = clampedLevel === 100 ? "16" : "18";

  return `
    <div class="battery-tooltip" data-tooltip="Baterai: ${clampedLevel}%">
      <div class="battery-container">
        <svg class="battery-svg" viewBox="0 0 100 50">
          <rect x="5" y="10" width="75" height="30" rx="3" ry="3" fill="none" stroke="#666" stroke-width="2"/>
          <rect x="80" y="18" width="8" height="14" rx="2" ry="2" fill="#666"/>
          <rect x="8" y="13" width="${fillWidth}" height="24" rx="2" ry="2" fill="${fillColor}"/>
          <text x="42.5" y="32" font-family="Arial, sans-serif" font-size="${fontSize}" font-weight="bold" fill="#fff" text-anchor="middle">${clampedLevel}%</text>
        </svg>
      </div>
    </div>
  `;
}

function renderRange(deviceId) {
  const rangeData = keyRangesData[deviceId];
  if (!rangeData || rangeData.start === undefined || rangeData.end === undefined) {
    return `<span class="range-badge no-range">-</span>`;
  }
  return `<span class="range-badge">${rangeData.start}-${rangeData.end}</span>`;
}

function renderUsers() {
  const searchTerm = searchInput.value.toLowerCase();
  const isToday = timeRange.value === "today";
  
  let filteredUsers = Object.entries(usersData).filter(([username, userData]) => {
    if (!userData.devices) return false;
    
    const matchSearch = username.toLowerCase().includes(searchTerm) ||
      Object.values(userData.devices).some(d => 
        (d.botName || "").toLowerCase().includes(searchTerm) ||
        (d.deviceName || "").toLowerCase().includes(searchTerm) ||
        (d.pkgName || "").toLowerCase().includes(searchTerm)
      );
    
    if (!matchSearch) return false;
    
    if (statusFilter.value === "all") return true;
    
    const hasActiveDevice = Object.values(userData.devices).some(d => {
      const sent = isToday ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
      return sent > 0;
    });
    
    return statusFilter.value === "active" ? hasActiveDevice : !hasActiveDevice;
  });
  
  if (filteredUsers.length === 0) {
    usersContainer.innerHTML = '<div class="empty">Tidak ada data yang sesuai filter</div>';
    return;
  }
  
  filteredUsers.sort((a, b) => {
    const getTotalSent = (userData) => {
      if (!userData.devices) return 0;
      return Object.values(userData.devices).reduce((sum, d) => {
        return sum + (isToday ? (d.sentToday ?? 0) : (d.totalSent ?? 0));
      }, 0);
    };
    return getTotalSent(b[1]) - getTotalSent(a[1]);
  });
  
  let html = '';
  
  filteredUsers.forEach(([username, userData]) => {
    if (!userData.devices) return;
    
    const devices = Object.entries(userData.devices).map(([deviceId, d]) => ({
      ...d,
      id: deviceId
    }));
    
    const totalSent = devices.reduce((sum, d) => 
      sum + (isToday ? (d.sentToday ?? 0) : (d.totalSent ?? 0)), 0
    );
    const activeDevices = devices.filter(d => 
      (isToday ? (d.sentToday ?? 0) : (d.totalSent ?? 0)) > 0
    ).length;
    
    const isExpanded = expandedUsers.has(username);
    const collapsedClass = isExpanded ? '' : 'collapsed';
    
    html += `
      <div class="user-section">
        <div class="user-header ${collapsedClass}" data-username="${username}">
          <div class="user-info">
<div class="user-name" title="${username}">üë§ ${maskUsername(username)}</div>
<div class="user-stats">
              <span><span class="label">Total:</span> <span class="value">${totalSent}</span></span>
              <span><span class="label">Devices:</span> <span class="value">${devices.length}</span></span>
              <span><span class="label">Active:</span> <span class="value">${activeDevices}</span></span>
            </div>
          </div>
          <div class="expand-icon">‚ñº</div>
        </div>
        
        <div class="devices-container ${collapsedClass}">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Bot Name</th>
                  <th>Sent</th>
                  <th>Bat</th>
                  <th>Range</th>
                  <th>App</th>
                  <th>Device</th>
                  <th>Version</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
    `;
    
    devices.forEach(d => {
      const sent = isToday ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
      const val = v => v || "-";
      const battery = d.battery !== undefined ? d.battery : d.batteryLevel !== undefined ? d.batteryLevel : null;
      
      html += `
        <tr>
          <td>${val(d.botName)}</td>
          <td>${sent}</td>
          <td>${renderBattery(battery)}</td>
          <td>${renderRange(d.id)}</td>
          <td>${val(d.pkgName)}</td>
          <td>${val(d.deviceName)}</td>
          <td>${val(d.appVersion ? "v." + d.appVersion : "")}</td>
          <td>${val(d.status)}</td>
        </tr>
      `;
    });
    
    html += `
              </tbody>
            </table>
          </div>
        </div>
      </div>
    `;
  });
  
  usersContainer.innerHTML = html;
  
  document.querySelectorAll('.user-header').forEach(header => {
    header.addEventListener('click', () => {
      const username = header.dataset.username;
      const container = header.nextElementSibling;
      
      if (expandedUsers.has(username)) {
        expandedUsers.delete(username);
        header.classList.add('collapsed');
        container.classList.add('collapsed');
      } else {
        expandedUsers.add(username);
        header.classList.remove('collapsed');
        container.classList.remove('collapsed');
      }
    });
  });
}

async function fetchKeyRanges() {
  try {
    const snapshot = await get(keyRangesRef);
    keyRangesData = {};
    let totalKeysAllocated = 0;
    let activeRanges = 0;
    
    snapshot.forEach(child => {
      const data = child.val();
      keyRangesData[child.key] = {
        start: data.start,
        end: data.end,
        lastSeen: data.lastSeen
      };
      
      totalKeysAllocated += (data.end - data.start + 1);
      const daysSince = (Date.now() - data.lastSeen) / (1000 * 60 * 60 * 24);
      if (daysSince < 7) activeRanges++;
    });
    
    const availableRanges = TOTAL_RANGES - activeRanges;
    statUsedApi.textContent = totalKeysAllocated;
    statAvailRange.textContent = availableRanges;
    
    console.log(`‚úÖ Loaded ${Object.keys(keyRangesData).length} key ranges`);
  } catch (err) {
    console.error("‚ùå Error key ranges:", err);
    statUsedApi.textContent = "0";
    statAvailRange.textContent = "0";
  }
}

async function fetchUsers() {
  try {
    const snapshot = await get(usersRef);
    usersData = {};
    let totalSent = 0;
    let activeDevices = 0;
    let totalUsers = 0;
    
    const isToday = timeRange.value === "today";
    
    snapshot.forEach(userChild => {
      const username = userChild.key;
      const userData = userChild.val();
      
      if (userData.devices) {
        totalUsers++;
        usersData[username] = userData;
        
        Object.values(userData.devices).forEach(device => {
          const sent = isToday ? (device.sentToday ?? 0) : (device.totalSent ?? 0);
          if (sent > 0) activeDevices++;
          totalSent += sent;
        });
      }
    });
    
    statUsers.textContent = totalUsers;
    statActive.textContent = activeDevices;
    statSent.textContent = totalSent;
    
    renderUsers();
    console.log(`‚úÖ Loaded ${totalUsers} users with devices`);
  } catch (err) {
    console.error("‚ùå Error fetching users:", err);
    usersContainer.innerHTML = '<div class="empty">Error loading data</div>';
  }
}

let chartData = {
  labels: [],
  totalSentData: [],
  avgPerDeviceData: [],
  dailyGrowthData: [],
  efficiencyGrowthData: [],
  activeDevicesData: []
};

async function fetchSentHistory() {
  try {
    const snapshot = await get(sentHistoryRef);
    const allDates = [];
    snapshot.forEach(child => { 
      const data = child.val();
      allDates.push({ 
        date: child.key, 
        totalSent: data.totalSent ?? 0,
        activeDevices: data.activeDevices ?? 0
      }); 
    });
    
    allDates.sort((a, b) => a.date.localeCompare(b.date));
    
    chartData.labels = allDates.map(d => d.date);
    chartData.totalSentData = allDates.map(d => d.totalSent);
    chartData.activeDevicesData = allDates.map(d => d.activeDevices);
    chartData.avgPerDeviceData = allDates.map(d => {
      return d.activeDevices > 0 ? parseFloat((d.totalSent / d.activeDevices).toFixed(2)) : 0;
    });

    chartData.dailyGrowthData = allDates.map((d, i) => {
      if (i === 0) return 0;
      const prev = allDates[i - 1].totalSent;
      if (prev === 0) return 0;
      return parseFloat((((d.totalSent - prev) / prev) * 100).toFixed(2));
    });

    chartData.efficiencyGrowthData = allDates.map((d, i) => {
      if (i === 0) return 0;
      const currAvg = d.activeDevices > 0 ? d.totalSent / d.activeDevices : 0;
      const prevAvg = allDates[i - 1].activeDevices > 0 ? allDates[i - 1].totalSent / allDates[i - 1].activeDevices : 0;
      if (prevAvg === 0) return 0;
      return parseFloat((((currAvg - prevAvg) / prevAvg) * 100).toFixed(2));
    });

    updateChart();
  } catch (err) {
    console.error("‚ùå Error history:", err);
  }
}
function maskUsername(username) {
  if (!username || username.length <= 3) return "***";
  return username.slice(0, -3) + "***";
}


function updateChart() {
  const showTotalSent = document.getElementById('check-total-sent').checked;
  const showAvgDevice = document.getElementById('check-avg-device').checked;
  const showDailyGrowth = document.getElementById('check-daily-growth').checked;
  const showEfficiencyGrowth = document.getElementById('check-efficiency-growth').checked;
  const showActiveDevices = document.getElementById('check-active-devices').checked;
  
  const traces = [];
  let yaxisCounter = 1;

  const getYAxis = () => {
    if (yaxisCounter === 1) {
      yaxisCounter++;
      return 'y';
    }
    const axis = `y${yaxisCounter}`;
    yaxisCounter++;
    return axis;
  };
  
  if (showTotalSent) {
    traces.push({
      x: chartData.labels,
      y: chartData.totalSentData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Total Sent',
      yaxis: getYAxis(),
      line: { color: '#90caf9', width: 2, shape: 'spline' },
      marker: { color: '#90caf9', size: 5 }
    });
  }

  if (showAvgDevice) {
    traces.push({
      x: chartData.labels,
      y: chartData.avgPerDeviceData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Avg per Device',
      yaxis: getYAxis(),
      line: { color: '#4caf50', width: 2, shape: 'spline' },
      marker: { color: '#4caf50', size: 5 }
    });
  }

  if (showDailyGrowth) {
    traces.push({
      x: chartData.labels,
      y: chartData.dailyGrowthData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Daily Growth %',
      yaxis: getYAxis(),
      line: { color: '#ff9800', width: 2, shape: 'spline' },
      marker: { color: '#ff9800', size: 5 }
    });
  }

  if (showEfficiencyGrowth) {
    traces.push({
      x: chartData.labels,
      y: chartData.efficiencyGrowthData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Efficiency Growth %',
      yaxis: getYAxis(),
      line: { color: '#ab47bc', width: 2, shape: 'spline' },
      marker: { color: '#ab47bc', size: 5 }
    });
  }

  if (showActiveDevices) {
    traces.push({
      x: chartData.labels,
      y: chartData.activeDevicesData,
      type: 'scatter',
      mode: 'lines+markers',
      name: 'Active Devices',
      yaxis: getYAxis(),
      line: { color: '#26c6da', width: 2, shape: 'spline' },
      marker: { color: '#26c6da', size: 5 }
    });
  }

  const layout = {
    paper_bgcolor: '#121212',
    plot_bgcolor: '#1e1e1e',
    font: { color: '#e0e0e0' },
    xaxis: {
      gridcolor: 'rgba(255,255,255,0.1)',
      showgrid: true,
      color: '#fff'
    },
    yaxis: {
      gridcolor: 'rgba(255,255,255,0.1)',
      showgrid: true,
      color: '#fff'
    },
    margin: { l: 50, r: 50, t: 20, b: 50 },
    hovermode: 'x unified',
    dragmode: 'pan',
    showlegend: false
  };

  const colors = ['#90caf9', '#4caf50', '#ff9800', '#ab47bc', '#26c6da'];
  let colorIdx = 0;
  
  traces.forEach((trace, idx) => {
    if (idx > 0 && trace.yaxis !== 'y') {
      const yaxisNum = trace.yaxis.replace('y', '');
      layout[`yaxis${yaxisNum}`] = {
        overlaying: 'y',
        side: idx % 2 === 0 ? 'right' : 'left',
        position: idx > 2 ? (idx % 2 === 0 ? 0.95 - (idx * 0.05) : 0.05 + (idx * 0.05)) : undefined,
        color: colors[colorIdx % colors.length],
        showgrid: false
      };
      colorIdx++;
    }
  });

  const config = {
    responsive: true,
    displayModeBar: true,
    modeBarButtonsToRemove: ['lasso2d', 'select2d'],
    scrollZoom: true,
    displaylogo: false
  };

  Plotly.newPlot('sentChart', traces, layout, config);
}

// Event listeners untuk chart checkboxes
document.getElementById('check-total-sent').addEventListener('change', updateChart);
document.getElementById('check-avg-device').addEventListener('change', updateChart);
document.getElementById('check-daily-growth').addEventListener('change', updateChart);
document.getElementById('check-efficiency-growth').addEventListener('change', updateChart);
document.getElementById('check-active-devices').addEventListener('change', updateChart);

  
const inactiveDevicesRef = ref(db, "inactiveDevices");

// Function baru untuk load inactive devices
async function loadInactiveDevices() {
  const today = new Date().toISOString().split('T')[0];
  
  try {
    const snapshot = await get(ref(db, `inactiveDevices/${today}`));
    
    // Remove existing warning
    const existingWarning = document.getElementById('inactive-warning');
    if (existingWarning) existingWarning.remove();
    
    if (snapshot.exists()) {
      const data = snapshot.val();
      const devices = data.devices;
      
      const warningHTML = `
        <div id="inactive-warning" class="warning-box">
          <h3>‚ö†Ô∏è ${data.count} Device Tidak Aktif Hari Ini</h3>
          <ul>
            ${devices.map(d => `
              <li>
                <div class="device-info">
                  <span class="device-name">${d.botName}</span>
                  <span class="device-meta">üë§ ${maskUsername(d.username)} ‚Ä¢ üì± ${d.deviceName}</span>
                </div>
                <span class="last-sent">Total: ${d.totalSent}</span>
              </li>
            `).join('')}
          </ul>
        </div>
      `;
      
      usersContainer.insertAdjacentHTML('beforebegin', warningHTML);
    }
  } catch (err) {
    console.error("‚ùå Error loading inactive devices:", err);
  }
}
// Main refresh function
async function refreshAll() {
  await fetchKeyRanges();
  await fetchUsers();
  await fetchSentHistory();
    await loadInactiveDevices(); 
}

// Initial load
refreshAll();

// Event listeners
document.getElementById("refreshBtn").addEventListener("click", refreshAll);
document.getElementById("total-sent-box").addEventListener("click", () => {
  document.getElementById("history-section").scrollIntoView({ behavior: "smooth", block: "start" });
});

document.getElementById("expandAllBtn").addEventListener("click", () => {
  Object.keys(usersData).forEach(username => expandedUsers.add(username));
  renderUsers();
});

document.getElementById("collapseAllBtn").addEventListener("click", () => {
  expandedUsers.clear();
  renderUsers();
});

[searchInput, timeRange, statusFilter].forEach(el => el.addEventListener("change", () => {
  fetchUsers();
}));
searchInput.addEventListener("input", () => {
  renderUsers();
});
</script>

<footer style="text-align:center; padding:12px; font-size:0.75rem; color:#777; margin-top:20px;">
  Powered by <span style="color:#90caf9;">mencretsu</span>
</footer>
</body>
</html>
