<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kecoaxx Dashboard</title>
<style>
body { font-family:"Roboto", sans-serif; background:#121212; color:#e0e0e0; margin:0; padding:10px; }
h1 { text-align:center; margin:10px 0 18px 0; font-size:1.4rem; color:#fff; }
.table-container { overflow-x:auto; margin-bottom:10px; }
table { width:100%; min-width:400px; border-collapse:collapse; background:#1e1e1e; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.6); font-size:0.7rem; }
thead { background:#272727; }
th, td { padding:6px 10px; text-align:left; cursor:default; }
th { color:#90caf9; font-weight:480; border-bottom:1px solid #333; white-space:nowrap; }
tr:nth-child(even) { background:#2a2a2a; }
tr:hover { background:#333; }
td { border-bottom:1px solid #2c2c2c; vertical-align:middle; }
.empty { text-align:center; padding:16px; color:#888; }
.filters { margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; }
th.sortable { cursor:pointer; }
.stats { display:flex; gap:16px; margin-bottom:10px; flex-wrap:wrap; }
.stat-box { background:#1e1e1e; padding:10px 16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.6); font-size:0.8rem; }
.stat-box span { font-weight:bold; color:#90caf9; }
canvas { display:block; max-width:100%; }
button { margin-top:10px; padding:6px 12px; background:#90caf9; color:#121212; border:none; border-radius:6px; cursor:pointer; }
.green-dot {
  display: inline-block;
  width: 10px;
  height: 10px;
  background: #4caf50;
  border-radius: 50%;
  margin-right: 6px;
}

/* LEADERBOARD STYLES */
.rank-cell {
  font-weight: bold;
  font-size: 0.85rem;
  text-align: center;
  min-width: 45px;
}

/* Rank 1 - Gold */
tr.rank-1 {
  background: linear-gradient(135deg, #3d2f1f 0%, #2a1f14 100%) !important;
  border-left: 4px solid #ffd700;
}
tr.rank-1:hover {
  background: linear-gradient(135deg, #4a3624 0%, #332619 100%) !important;
}
tr.rank-1 .rank-cell {
  color: #ffd700;
  text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
}

/* Rank 2-3 - Silver */
tr.rank-2, tr.rank-3 {
  background: linear-gradient(135deg, #2e3236 0%, #1f2225 100%) !important;
  border-left: 4px solid #c0c0c0;
}
tr.rank-2:hover, tr.rank-3:hover {
  background: linear-gradient(135deg, #373c41 0%, #272b2f 100%) !important;
}
tr.rank-2 .rank-cell, tr.rank-3 .rank-cell {
  color: #c0c0c0;
  text-shadow: 0 0 6px rgba(192, 192, 192, 0.5);
}

/* Rank 4-10 - Bronze */
tr.rank-4, tr.rank-5, tr.rank-6, tr.rank-7, tr.rank-8, tr.rank-9, tr.rank-10 {
  background: linear-gradient(135deg, #2d2419 0%, #211a12 100%) !important;
  border-left: 4px solid #cd7f32;
}
tr.rank-4:hover, tr.rank-5:hover, tr.rank-6:hover, tr.rank-7:hover, 
tr.rank-8:hover, tr.rank-9:hover, tr.rank-10:hover {
  background: linear-gradient(135deg, #352a1f 0%, #281f16 100%) !important;
}
tr.rank-4 .rank-cell, tr.rank-5 .rank-cell, tr.rank-6 .rank-cell, 
tr.rank-7 .rank-cell, tr.rank-8 .rank-cell, tr.rank-9 .rank-cell, tr.rank-10 .rank-cell {
  color: #cd7f32;
  text-shadow: 0 0 4px rgba(205, 127, 50, 0.4);
}

/* Rank 11-20 - Purple */
tr.rank-11, tr.rank-12, tr.rank-13, tr.rank-14, tr.rank-15, 
tr.rank-16, tr.rank-17, tr.rank-18, tr.rank-19, tr.rank-20 {
  background: linear-gradient(135deg, #291c2e 0%, #1a131d 100%) !important;
  border-left: 4px solid #9c27b0;
}
tr.rank-11:hover, tr.rank-12:hover, tr.rank-13:hover, tr.rank-14:hover, tr.rank-15:hover,
tr.rank-16:hover, tr.rank-17:hover, tr.rank-18:hover, tr.rank-19:hover, tr.rank-20:hover {
  background: linear-gradient(135deg, #332438 0%, #221a27 100%) !important;
}
tr.rank-11 .rank-cell, tr.rank-12 .rank-cell, tr.rank-13 .rank-cell, tr.rank-14 .rank-cell, 
tr.rank-15 .rank-cell, tr.rank-16 .rank-cell, tr.rank-17 .rank-cell, tr.rank-18 .rank-cell, 
tr.rank-19 .rank-cell, tr.rank-20 .rank-cell {
  color: #9c27b0;
  text-shadow: 0 0 4px rgba(156, 39, 176, 0.4);
}

/* Medal icons */
.medal {
  font-size: 1.1rem;
  margin-right: 4px;
}
</style>
</head>
<body>

<h1>üèÜ Kecoaxx Leaderboard</h1>

<div class="stats">
<div class="stat-box">
  <span class="green-dot"></span>
  Active Devices: <span id="stat-active">0</span>
</div>
  <div class="stat-box">Total Sent: <span id="stat-sent">0</span></div>
  <div class="stat-box">Total API: <span id="stat-totalapi">0</span></div>
</div>

<div class="filters">
  <input type="text" id="searchInput" placeholder="Cari nama, app, atau versi..." />
  <select id="timeRange">
    <option value="today">Hari ini</option>
    <option value="all">Semua</option>
  </select>
  <select id="statusFilter">
    <option value="active">Show Active</option>
    <option value="inactive">Show Inactive</option>
    <option value="all">Show All</option>
  </select>
  <button id="refreshBtn">Refresh Data</button>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>Rank</th>
        <th>Nama</th>
        <th class="sortable">Sent ‚ñ≤‚ñº</th>
        <th>Device</th>
        <th>Bot</th>
        <th>App</th>
        <th>API Ranges</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="devices-table">
      <tr><td colspan="8" class="empty">Loading data...</td></tr>
    </tbody>
  </table>
</div>

<br><br>-- Stats --<br>
<div style="overflow-x:auto;">
  <canvas id="sentChart" height="200"></canvas>
</div>
<button id="resetZoom">Reset Zoom</button>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.2.0/dist/chartjs-plugin-zoom.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBWrIDwTn4Byd9gZdYeGtwVUe0q2f2KYT4",
  authDomain: "kecoaxx-db898.firebaseapp.com",
  databaseURL: "https://kecoaxx-db898-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "kecoaxx-db898",
  storageBucket: "kecoaxx-db898.firebasestorage.app",
  messagingSenderId: "929070876762",
  appId: "1:929070876762:web:696c8699f91e8022cc7063"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const devicesRef = ref(db, "devices");
const sentHistoryRef = ref(db, "sentHistory");
const apiKeysRef = ref(db, "apiKeys/list");

// DOM
const searchInput = document.getElementById("searchInput");
const timeRange = document.getElementById("timeRange");
const statusFilter = document.getElementById("statusFilter");
const table = document.getElementById("devices-table");
const statActive = document.getElementById("stat-active");
const statSent = document.getElementById("stat-sent");
const statTotalApi = document.getElementById("stat-totalapi");

// Table & Sorting
let devicesData = [];
let sortSentAsc = false;

function getMedalIcon(rank) {
  if (rank === 1) return '<span class="medal">ü•á</span>';
  if (rank === 2) return '<span class="medal">ü•à</span>';
  if (rank === 3) return '<span class="medal">ü•â</span>';
  return '';
}

// Render Table
function renderTable() {
  table.innerHTML = "";
  let filtered = devicesData.filter(d => {
    const searchTerm = searchInput.value.toLowerCase();
    const name = (d.botName || "").toLowerCase();
    const app = (d.pkgName || "").toLowerCase();
    const version = (d.appVersion || "").toLowerCase();
    
    return name.includes(searchTerm) || app.includes(searchTerm) || version.includes(searchTerm);
  });
  
  // Filter by status
  filtered = filtered.filter(d => {
    const sent = timeRange.value === "today" ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
    const isActive = sent > 0;
    
    if (statusFilter.value === "active") return isActive;
    if (statusFilter.value === "inactive") return !isActive;
    return true;
  });
  
  // SORTING DEFAULT: dari sent tertinggi ke terkecil
  filtered.sort((a, b) => {
    const valA = timeRange.value === "today" ? (a.sentToday ?? 0) : (a.totalSent ?? 0);
    const valB = timeRange.value === "today" ? (b.sentToday ?? 0) : (b.totalSent ?? 0);
    return valB - valA;
  });
  
  filtered.forEach((d, index) => {
    const rank = index + 1;
    let sent = timeRange.value === "today" ? (d.sentToday ?? 0) : (d.totalSent ?? 0);
    
    const rangeStart = d.rangeStart !== undefined ? d.rangeStart : "-";
    const rangeEnd = d.rangeEnd !== undefined ? d.rangeEnd : "-";
    const rangeDisplay = (rangeStart !== "-" && rangeEnd !== "-") ? `${rangeStart}-${rangeEnd}` : "-";
    
    const val = v => v ? v : "-";
    
    const rankClass = `rank-${rank <= 20 ? rank : 'default'}`;
    const medalIcon = getMedalIcon(rank);
    
    table.innerHTML += `
      <tr class="${rankClass}">
        <td class="rank-cell">${medalIcon}#${rank}</td>
        <td>${val(d.botName)}</td>
        <td>${val(sent)}</td>
        <td>${val(d.deviceName || d.id)}</td>
        <td>${val(d.appVersion ? "v." + d.appVersion : "")}</td>
        <td>${val(d.pkgName)}</td>
        <td>${val(rangeDisplay)}</td>
        <td>${val(d.status)}</td>
      </tr>`;
  });
  if (filtered.length === 0) table.innerHTML = `<tr><td colspan="8" class="empty">Tidak ada data</td></tr>`;
}

// Fetch Devices
async function fetchDevices() {
  try {
    const snapshot = await get(devicesRef);
    devicesData = [];
    let totalSent = 0, activeCount = 0;

    snapshot.forEach(child => {
      const d = child.val();
      d.id = child.key;

      let sentValue = 0;
      if (timeRange.value === "today" && d.hasOwnProperty('sentToday')) sentValue = d.sentToday;
      else if (timeRange.value === "all" && d.hasOwnProperty('totalSent')) sentValue = d.totalSent;

      if (sentValue > 0) activeCount++;
      totalSent += sentValue;

      d._sentValue = sentValue;
      devicesData.push(d);
    });

    statActive.textContent = activeCount;
    statSent.textContent = totalSent;
    renderTable();
  } catch (err) {
    console.error("Error devices:", err);
    table.innerHTML = `<tr><td colspan="8" class="empty">Error ambil data</td></tr>`;
  }
}

async function fetchApiKeysCount() {
  try {
    const snapshot = await get(apiKeysRef);
    let apiCount = 0;
    snapshot.forEach(() => {
      apiCount++;
    });
    statTotalApi.textContent = apiCount;
  } catch (err) {
    console.error("Error API keys:", err);
    statTotalApi.textContent = "0";
  }
}

// Fetch Sent History
const ctx = document.getElementById("sentChart").getContext("2d");
let sentChart = null;

async function fetchSentHistory() {
  try {
    const snapshot = await get(sentHistoryRef);
    const allDates = [];
    snapshot.forEach(child => { 
      allDates.push({ date: child.key, total: child.val().totalSent ?? 0 }); 
    });
    const labels = allDates.map(d => d.date);
    const dataPoints = allDates.map(d => d.total);

    if (sentChart) sentChart.destroy();

    sentChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: "History",
          data: dataPoints,
          fill: true,
          borderColor: "#90caf9",
          backgroundColor: "rgba(144,202,249,0.2)",
          tension: 0.3,
          pointRadius: 3,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { labels: { color: "#fff" } },
          tooltip: { mode: 'index', intersect: false },
          zoom: {
            pan: { enabled: true, mode: 'x', overScaleMode: 'x' },
            zoom: {
              wheel: { enabled: true },
              pinch: { enabled: true },
              mode: 'x',
              limits: {
                x: { min: 0, max: labels.length - 1 },
                y: { min: 0 }
              }
            }
          }
        },
        interaction: { mode: 'nearest', axis: 'x', intersect: false },
        scales: {
          x: { 
            ticks: { color: "#fff", maxRotation: 0, autoSkip: true }, 
            grid: { color: "rgba(255,255,255,0.1)" } 
          },
          y: { 
            ticks: { color: "#fff", beginAtZero: true }, 
            grid: { color: "rgba(255,255,255,0.1)" } 
          }
        }
      }
    });
  } catch (err) {
    console.error("Error history:", err);
  }
}

// Manual refresh
async function refreshAll() {
  await fetchDevices();
  await fetchApiKeysCount();
  await fetchSentHistory();
}

// Init
refreshAll();

// Button event
document.getElementById("refreshBtn").addEventListener("click", refreshAll);
document.getElementById("resetZoom").addEventListener("click", () => { if (sentChart) sentChart.resetZoom(); });

// Filters
[searchInput, timeRange, statusFilter].forEach(el => el.addEventListener("change", renderTable));
searchInput.addEventListener("input", renderTable);

// Sort column
document.querySelector("th.sortable").addEventListener("click", () => {
  devicesData.sort((a, b) => {
    const valA = timeRange.value === "today" ? (a.sentToday ?? 0) : (a.totalSent ?? 0);
    const valB = timeRange.value === "today" ? (b.sentToday ?? 0) : (b.totalSent ?? 0);
    return sortSentAsc ? valB - valA : valA - valB;
  });
  sortSentAsc = !sortSentAsc;
  renderTable();
});
</script>
<footer style="text-align:center; padding:12px; font-size:0.75rem; color:#777; margin-top:20px;">
  Powered by <span style="color:#90caf9;">mencretsu</span>
</footer>
</body>
</html>
